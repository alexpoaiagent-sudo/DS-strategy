# Архитектура экзокортекса

> Документ для людей. Объясняет как устроена вся система, зачем каждая часть,
> как они связаны между собой.
>
> Последнее обновление: 2026-02-26
> Актуальная версия для агентов: `~/.claude/projects/.../memory/project-brain.md`

---

## Что это такое и зачем

Персональный экзокортекс — автоматизированная система управления знаниями и планированием.

**Проблема которую решает:** мысли появляются в разное время, в разных местах, теряются или не превращаются в действия. Нет единой картины что происходит в проектах.

**Что делает система:**
1. Собирает сырые мысли из Obsidian (телефон, ноутбук)
2. Автоматически сортирует их по проектам
3. Извлекает знания и формализует в базу
4. Каждое утро готовит план дня через AI-агента
5. Каждую неделю делает обзор и корректирует курс
6. Всё синхронизирует в GitHub как резервную копию

---

## Репозитории — что где лежит

```
~/Github/
├── FMT-exocortex-template/   ← шаблон системы (платформа, только читать)
├── VK-offee/                 ← база знаний кофейни (source-of-truth)
├── DS-strategy/              ← этот репо: планы, отчёты, inbox агентов
├── creativ-convector/        ← творческий конвейер: обработанные заметки
├── close-task.sh             ← скрипт закрытия задачи (обязательный)
└── strategist-wrapper.sh     ← обёртка для запуска стратега

~/Documents/
└── creativ-convector.nocloud/ ← Obsidian vault (только локально, не в GitHub)
```

### Роль каждого репо

| Репо | Тип | Главное правило |
|------|-----|----------------|
| `FMT-exocortex-template` | Base/Format | Платформенный шаблон. Не менять под себя — только читать и использовать |
| `VK-offee` | Pack | Единственный source-of-truth для домена кофейни. Всё остальное следует за ним |
| `DS-strategy` | Governance | Живой хаб: планы недели, контекст сессий, очередь для агентов |
| `creativ-convector` | Downstream | Следует за Pack. Хранит обработанные заметки и сессии стратегирования |

---

## Агенты — кто что делает

Все агенты работают автоматически через macOS launchd (аналог cron, но надёжнее).

### Центральный диспетчер: `com.exocortex.scheduler`

**Расписание:** 10 раз в день (0:00, 3:00, 4:00, 6:00, 9:00, 12:00, 15:00, 18:00, 21:00, 23:00)

Это мозг расписания. Не запускает агентов напрямую — проверяет маркеры в
`~/.local/state/exocortex/` и решает что пора запустить. Предотвращает дублирование.

### Стратег: `com.strategist.morning`

**Расписание:** 4:00 ежедневно

- Понедельник → готовит план на неделю (`session-prep`)
- Вторник–Воскресенье → готовит план дня (`day-plan`)

Claude читает текущий WeekPlan и SESSION-CONTEXT, пишет структурированный план,
коммитит в DS-strategy, пушит в GitHub.

### Стратег: `com.strategist.weekreview`

**Расписание:** Понедельник 00:00

Обзор прошедшей недели. Claude анализирует что было сделано, что нет, корректирует приоритеты.

### Экстрактор: `com.extractor.inbox-check`

**Расписание:** каждые 3 часа (только в рабочие часы 7:00–23:00)

Проверяет `DS-strategy/inbox/captures.md` — есть ли необработанные записи.
Если есть → Claude извлекает знания и формализует их в VK-offee.

### Наблюдатель сессий: `com.extractor.session-watcher`

**Расписание:** каждые 5 минут

Следит за папкой `DS-strategy/inbox/pending-sessions/`.
Когда туда попадает файл сессии стратегирования → автоматически запускает обработку.

---

## Поток данных: от мысли до знания

```
[1] Пользователь пишет заметку в Obsidian
        ↓
[2] ~/Documents/creativ-convector.nocloud/1. Исчезающие заметки/
        ↓  запуск strategy_session.py
[3] Заметки сортируются по проектам и ролям FPF (F1–F9)
    → ~/Github/creativ-convector/2. Черновики/{Проект}/{Роль}/
    → создаётся файл сессии стратегирования
        ↓  автоматически
[4] Файл сессии → DS-strategy/inbox/pending-sessions/
        ↓  session-watcher.sh (≤5 мин)
[5] extractor обрабатывает сессию
    → DS-strategy/inbox/captures.md  (pending captures)
        ↓  inbox-check (каждые 3ч)
[6] Claude извлекает знания из captures
    → DS-strategy/inbox/extraction-reports/
    → VK-offee/  (знания формализованы в базе)
```

---

## Локально vs GitHub (облако)

| Данные | Локально | GitHub |
|--------|----------|--------|
| Obsidian vault (`.nocloud`) | ✅ | ❌ никогда |
| Сырые заметки до обработки | ✅ | ❌ |
| Логи агентов (`~/logs/`) | ✅ | ❌ |
| Маркеры состояния (`~/.local/state/exocortex/`) | ✅ | ❌ |
| Обработанные заметки, черновики | ✅ | ✅ |
| Планы, отчёты, SESSION-CONTEXT | ✅ | ✅ |
| База знаний VK-offee | ✅ | ✅ |
| Скрипты и шаблоны агентов | ✅ | ✅ |

**Правило:** в GitHub попадает только то, что прошло обработку. Сырые мысли — только локально.

---

## Ключевые файлы

```
DS-strategy/current/SESSION-CONTEXT.md   — где остановились в прошлой сессии
DS-strategy/current/WeekPlan*.md          — план текущей недели
DS-strategy/inbox/captures.md             — очередь знаний для экстрактора
DS-strategy/inbox/pending-sessions/       — очередь сессий для обработки
DS-strategy/exocortex/                    — backup памяти агента (MEMORY.md и др.)

~/Github/close-task.sh                    — ОБЯЗАТЕЛЬНО запускать после каждой задачи
~/.config/aist/env                        — Telegram токены, API ключи (не в git)
```

---

## Архитектурные решения — почему именно так

**Почему wrapper для стратега, а не правка шаблона:**
`FMT-exocortex-template` — платформенный репо, его нельзя менять под себя.
`strategist.sh` хардкодит путь к Claude. Решение: `strategist-wrapper.sh` переопределяет
путь перед вызовом. Шаблон остаётся чистым.

**Почему scheduler, а не просто cron для каждого агента:**
Без диспетчера агенты работают независимо и могут конфликтовать (два запуска Claude
одновременно = crash). Scheduler через маркеры гарантирует что каждый агент
запускается ровно столько раз сколько нужно.

**Почему .nocloud не пушится:**
Obsidian vault — это поток сознания: черновики, личные мысли, незаконченные идеи.
Они не должны быть в публичном репо. После обработки через `strategy_session.py`
очищенные версии попадают в `creativ-convector` (GitHub).

**Почему VK-offee = source-of-truth:**
Знания о домене (кофейня) должны жить в одном месте. Если они размазаны по заметкам
и черновикам — агенты получают противоречивую информацию. Pack решает это:
одно место, проверенные данные, всё остальное следует за ним.

---

## Статус системы (2026-02-26)

| Агент | Статус | Примечание |
|-------|--------|-----------|
| `com.exocortex.scheduler` | ✅ работает | Развёрнут 2026-02-26 |
| `com.strategist.morning` | ✅ работает | |
| `com.strategist.weekreview` | ✅ работает | |
| `com.extractor.inbox-check` | ✅ работает | До 26.02 падал: не был залогинен |
| `com.extractor.session-watcher` | ✅ работает | |

**Важно:** все агенты требуют активной OAuth сессии Claude.
При сбросе авторизации → `claude /login` в терминале.

### Что ещё не сделано

- [ ] Telegram уведомления: проверить с реальными токенами
- [ ] `daily-report.sh` и `code-scan.sh` (synchronizer): не тестировались
- [ ] Агенты `evening`, `note-review`, `day-close`: работают через scheduler, отдельных launchd нет

---

## История изменений

| Дата | Что сделано |
|------|------------|
| 2026-02-26 | Развёрнут scheduler. Исправлены плейсхолдеры в скриптах. OAuth login. Создан project-brain.md. Добавлен backup memory/. |
| 2026-02-25 | Создан strategist-wrapper.sh. Исправлены plist агентов. Добавлена синхронизация контекста в протоколы. |
| 2026-02-22 | Первичная интеграция экзокортекса с VK-offee и creativ-convector. |
